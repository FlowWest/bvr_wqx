---
title: "Field Data Cleaning and Upload"
author: "Inigo Peng"
date: "2022-10-12"
runtime: shiny
output: 
  html_document:
    code_folding: hide
---
## Data Description



| | |
|:-|:-|
|**Colection Method**        |    Sampling Bottles|
|**Raw File Format**         | Field Data CSV |
|**Monitoring (Project ID)** | |
|**WQX submittal required?** | Yes |
|**Rate of Upload** | None|


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      tidy.opts = list(width.cutoff = 60), tidy = TRUE)

library(tidyverse)
library(readxl) 
library(lubridate)
library(wqxWeb)
library(DT)
library(shiny)
library(stringr)
library(emo)
# reticulate::use_condaenv("r-reticulate")
# Sys.setenv()
```

```{r, include=FALSE}
project_id_lookup <- c(
  "M1" = "MS",
  "M2" = "MS",
  "M3" = "MS",
  "M4" = "MS",
  "HSP" = "SW",
  "BVSWD1" = "SW",
  "NBPRSC" = "SW",
  "RSTCC" = "SW",
  "BVCL1" = "SW",
  "BVRTC1" = "SW",
  "BVRTCC" = "SW",
  "BVSWDRV" = "SW",#not in cdx
  "RVSI1" = "SW",#not in cdx
  "RVSI2" = "SW",#not in cdx
  "BVCL2" = "CLM",	
  "BVCL3" = "CLM",	
  "BVCL5" = "CLM",	
  "BVCL6" = "CLM",	
  "BVCL11" = "CLM",	
  "BVCL12" = "CLM",	
  "BVCL13" = "CLM",	
  "BVCL14" = "CLM",	
  "BVCL15" = "CLM",	
  "BVCL16" = "CLM",	
  "BVCL17" = "CLM",	
  "BVCL18" = "CLM",	
  "BVCL19" = "CLM",	
  "BVCL20" = "CLM",
  "FC1" = "CS", 
  "FC2" = "CS",
  "FC3" = "CS",#not in cdx
  "MC1" = "CS",
  "MC2" = "CS",
  "TC1" = "CS",
  "AC1" = "CS",
  "AC2" = "CS",
  "AC3" = "CS",
  "AC4" = "CS",
  "MCC1" = "CS",
  "KC1" = "CS",
  "CC1" = "CS",
  "SC1" = "CS",
  "SC2" = "CS",#not in cdx
  "SHC2"= "CS",#not in cdx
  "CC2" = "CS",#not in cdx
  "SIEG01" = "CS",#not in cdx
  "COOP01" = "CS",#not in cdx
  "CLOV01" = "CS",#not in cdx
  "DRY01" = "CS",#not in cdx
  "COY01" = "CS",#not in cdx
  "SCOT01"= "CS",#not in cdx
  "AND01" = "CS",#not in cdx
  "NFORK01" = "CS",#not in cdx
  "LONG01" = "CS", #not in cdx
  "PUT01" = "CS", #not in cdx
  "MID01"= "CS", #not in cdx
  "KC5"= "CS", #not in cdx
  "AP01" = "HAB",
  "BP" = "HAB",
  "CLOAKS01" = "HAB",
  "CLV7" = "HAB",
  "CP" = "HAB",
  "ELEM01" = "HAB",
  "GH" = "HAB",
  "HB" = "HAB",
  "JB" = "HAB",
  "KEYS01" = "HAB",
  "KEYS03" = "HAB",
  "KP01" = "HAB",
  "LC01" = "HAB",
  "LPTNT" = "HAB",
  "LS" = "HAB",
  "LS2" = "HAB",
  "LUC01" = "HAB",
  "RED01" = "HAB",
  "RODS" = "HAB",
  "SBMMEL01" = "HAB",
  "SHADY01" = "HAB",
  "UBL" = "HAB",
  "CL-1" = "HAB",
  "CL-3" = "HAB",
  "CL-4" = "HAB",
  "CL-5" = "HAB",
  "LA-03" = "HAB",
  "NR-02" = "HAB",
  "OA-04" = "HAB",
  "UA-01" = "HAB",
  "UA-06" = "HAB",
  "UA-07" = "HAB",
  "UA-08" = "HAB",
  "PILLS01" = "HAB", #not in cdx
  "LAKEPILS01" = "HAB" #not in cdx
  )

unit_lookup <- c(
  "Temperature, water" = "deg C", 
  "Specific conductance" = "mS/cm", 
  "Resistivity" = "KOhm/cm", 
  "Salinity" = "ppt", 
  "Total dissolved solids" = "g/L", 
  "Dissolved oxygen saturation" = "%",
  "Dissolved oxygen (DO)" = "mg/L", 
  "pH" = "None", 
  "Turbidity" = "NTU",
  "Oil & Grease (HEM)" = "mg/L",
  "Nitrate + Nitrite as N" = "mg/L",
  "Phosphorus, total" = "mg/L",
  "Total Organic Carbon" = "mg/L")

method_id_lookup <- c(
  "SM9223B" = "9223-B",
  "EPA 300.0" = "300.0",
  "ELISA" = "520060",
  "QPCR" = "1611",
  "EPA 1664A" = "1664A",
  "SM4500-NO3 E" = "4500-NO3(E)",
  "SM4500-P F" = "4500-P-F",
  "SM5310C" = "5310-C"
)

method_context_lookup <- c(
  "SM9223B" = "APHA",
  "EPA 300.0" = "USEPA",
  "ELISA" = "ABRAXIS LLC",
  "QPCR" = "USEPA",
  "EPA 1664A" = "USEPA",
  "SM4500-NO3 E" = "APHA",
  "SM4500-P F" = "APHA",
  "SM5310C" = "APHA"
  
)

characteristic_lookup <- c(
  "Oil & Grease (HEM)" = "Oil and Grease",
  "Phosphorus, total" = "Phosphorus",
  "Total Organic Carbon" = "Organic carbon",
  "E. Coli" = "Escherichia coli"
)

project_sites <- c(
  "M1",
  "M2",
  "M3",
  "M4",
  "HSP",
  "BVSWD1",
  "NBPRSC",
  "RSTCC",
  "BVCL1",
  "BVRTC1",
  "BVRTCC",
  "BVSWDRV",#not in cdx
  "RVSI1",#not in cdx
  "RVSI2",#not in cdx
  "BVCL2",	
  "BVCL3",	
  "BVCL5",	
  "BVCL6",	
  "BVCL11",	
  "BVCL12",	
  "BVCL13",	
  "BVCL14",	
  "BVCL15",	
  "BVCL16",	
  "BVCL17",	
  "BVCL18",	
  "BVCL19",	
  "BVCL20",
  "FC1",
  "FC2",
  "FC3",#not in cdx
  "MC1",
  "MC2",
  "TC1",
  "AC1",
  "AC2",
  "AC3",
  "AC4",
  "MCC1",
  "KC1",
  "CC1",
  "SC1",
  "SC2",#not in cdx
  "SHC2",#not in cdx
  "CC2",#not in cdx
  "SIEG01",#not in cdx
  "COOP01",#not in cdx
  "CLOV01",#not in cdx
  "DRY01",#not in cdx
  "COY01",#not in cdx
  "SCOT01",#not in cdx
  "AND01",#not in cdx
  "NFORK01",#not in cdx
  "LONG01", #not in cdx
  "PUT01", #not in cdx
  "MID01", #not in cdx
  "KC5", #not in cdx
  "AP01",
  "BP",
  "CLOAKS01",
  "CLV7",
  "CP",
  "ELEM01",
  "GH",
  "HB",
  "JB",
  "KEYS01",
  "KEYS03",
  "KP01",
  "LC01",
  "LPTNT",
  "LS",
  "LS2",
  "LUC01",
  "RED01",
  "RODS",
  "SBMMEL01",
  "SHADY01",
  "UBL",
  "CL-1",
  "CL-3",
  "CL-4",
  "CL-5",
  "LA-03",
  "NR-02",
  "OA-04",
  "UA-01",
  "UA-06",
  "UA-07",
  "UA-08",
  "PILLS01", #not in cdx
  "LAKEPILS01"  #not in cdx
)
```

## Load Data

Click on browse and find the appropriate Field Data excel files on your computer. Select the file that needs to go through QA/QC Process. 

We will read the excel files using the function `read_excel()` from the readxl package. 

Example:
Here is an example of reading in the file using the `read_excel()` function.

```{r, class.source = 'fold-show'}
wqx_data <- read_excel("data-raw/WQXJan-Dec2020.xlsx", sheet = "Results") 
```

The chunk below will parse the file. Once the parsing is finished, the data frame will appear below this chunk.

```{r, echo=FALSE}
fileInput("field_file",
          "Choose WQX Field Excel File",
          multiple = FALSE)

all_files <- reactive({
  
  req(input$field_file)
  
  raw_field_data <- read_excel(input$field_file$datapath, sheet = "Results")
  
  return (raw_field_data)
})

renderDataTable(
  all_files(), 
  options=list(scrollX=T)
)

```

## Explore Numeric Variables

Now we explore these numeric values. 

```{r}
wqx_data |> select_if(is.numeric) |> colnames()
```

### Variable: `Activity Depth/Height Measure`, `Result Value`, `Result Detection/Quantitation Limit Measure`

The summary function produces summaries of the results such as min, max. Values that are not in the normal range could be spotted.

```{r}
summary(wqx_data$`Activity Depth/Height Measure`)
summary(wqx_data$`Result Value`)
summary(wqx_data$`Result Detection/Quantitation Limit Measure`)

```



## Explore water quality variables: {.tabset}

```{r}
unique(wqx_data$`Characteristic Name`)
```
We could see that there a   re variables where they are the same but with different capitalization (eg. "Temperature , Water" and "Temperature, water".). We will make it uniform so that we get a more accurate presentation of the data spread.

```{r}
wqx_data_cleaned <- wqx_data |> 
  mutate(case_when(`Characteristic Name` == "Temperature, Air" ~ "Temperature, air",
                   `Characteristic Name` == "Temperature, Water" ~ "Temperature, water",
                   `Characteristic Name` == "Organic carbon" ~ "Organic Carbon",
                   `Characteristic Name` == "Anatoxin-A" ~ "Anatoxin-a",
                   `Characteristic Name` == "Specific conductance" ~ "Specific Conductance",
                   TRUE ~ as.character(`Characteristic Name`)))
```


### Variable: `Result Value`

**Plotting result value per water quality variable 

```{r}
wqx_data |> 
  ggplot(aes(x = `Result Value`,  y = `Characteristic Name`)) +
  geom_boxplot(color = "blue") +
  labs(x = "Result Value",
       y = "Characteristic Name") +
  theme_minimal()
```

We could filter our data based on each water quality variable to get a more detailed look at each variable.

### Water Quality Characteristic: Temperature, air
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Temperature, air") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot() +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()
```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Temperature, air") |> 
          select(`Result Value`))
```


### Water Quality Characteristic: Temperature, water
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Temperature, water") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Temperature, water") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Specific conductance
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Specific conductance") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Specific conductance") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Resistivity
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Resistivity") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Resistivity") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Salinity
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Salinity") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Salinity") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Total dissolved solids
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Total dissolved solids") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Total dissolved solids") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Turbidity
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Turbidity") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Turbidity") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Chlorophyll a
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Chlorophyll a") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Chlorophyll a") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Phycocyanin
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Phycocyanin") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Phycocyanin") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Dissolved oxygen saturation
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Dissolved oxygen saturation") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Dissolved oxygen saturation") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Dissolved oxygen (DO)
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Dissolved oxygen (DO)") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Dissolved oxygen (DO)") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: pH
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "pH") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "pH") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Velocity - stream
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Velocity - stream") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Velocity - stream") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: RBP2, Instream features, est. stream depth
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "RBP2, Instream features, est. stream depth") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "RBP2, Instream features, est. stream depth") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Total Coliform
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Total Coliform") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Total Coliform") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Fecal Coliform
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Fecal Coliform") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Fecal Coliform") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Oil and Grease
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Oil and Grease") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Oil and Grease") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Kjeldahl Nitrogen
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Kjeldahl Nitrogen") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Kjeldahl Nitrogen") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Phosphorus
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Phosphorus") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Phosphorus") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Organic Carbon
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Organic Carbon") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Organic Carbon") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Depth, Secchi disk depth
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Depth, Secchi disk depth") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Depth, Secchi disk depth") |> 
          select(`Result Value`))
```

### Water Quality Characteristic: Anatoxin-a
```{r}
wqx_data |> 
  filter(`Characteristic Name` == "Anatoxin-a") |> 
  ggplot(aes(x = `Characteristic Name`, y = `Result Value`)) +
  geom_boxplot(color = "blue") +
  labs(y = "Result Value",
       x = "Characteristic Name") +
  theme_minimal()

```
```{r}
summary(wqx_data |> 
          filter(`Characteristic Name` == "Anatoxin-a") |> 
          select(`Result Value`))
```

