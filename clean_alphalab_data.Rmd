---
title: "AlphaLab Data Wrangling"
author: "Inigo Peng"
date: "2022-10-12"
output: html_document
---
# AlphaLab Data
# Description of Data

**Collection method:**

Sampling Bottles

**Raw File format:**

AlphaLab CSV lab report

**Monitoring (Project ID)**

Storm Water Sampling (SW), Tap Water Sampling (CalWATCH).

**WQX submittal required?**

Storm Water Sampling YES. Tap Water Sampling NO.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readxl)
library(ggplot2)
library(janitor)
library(lubridate)
```

## Data transformations

Read in individual AlphaLab excel file using the function read_excel().

```{r}
raw_alpha_data <- read_excel('data-raw/alpha-lab/22G2998 FINAL EXCEL 09 Aug 22 1018.xls') |> glimpse()
```

Alternatively, we could read in all of the files in the folder at once and bind them by row into one data frame. We do this by listing out all of the files in the folder using the function list.files(). We then apply the function read_excel() and bind all of the files into a dataframe using map_df().

```{r}
raw_alpha_data <-
  list.files("data-raw/alpha-lab",
             full.names = T) |> 
  map_df(~read_excel(.))
```

Before transforming the results data into WQX format, we will create a function that will help to make the "Activity ID" of WQX file. To maek the Activity ID, it needs location ID, date, activity type, equipment name, depth, time and equipment comment.

```{r}
make_activity_id <- function(location_id, date, activity_type, equipment_name, depth = NULL, time = NULL, equipment_comment = NULL) {
  YYYYMMDD <- gsub('/', '', date)
  activity <- ifelse(activity_type == "Sample-Routine", "SR", "FM")
  equipment <- case_when(
      equipment_name == "Probe/Sensor" ~ "PS",
      equipment_name == "Water Bottle" ~ "WB",
      TRUE ~ NA_character_
    )
  hhmm <- gsub(':', '', time)
  equipment_comment <- case_when(
    equipment_comment == "Hydrolab Surveyor DS5 Multiprobe" ~ "Hydro",
    equipment_comment == "AlgaeChek Ultra Fluorometer" ~ "Algae", 
    TRUE ~ NA_character_)
  depth <- ifelse(is.na(depth), "", depth)
  paste(location_id, YYYYMMDD, hhmm,activity, equipment, depth, equipment_comment, sep = ":")
}
```

To transform the data into WQX format, we will first run the function clean_names() to make the column names easier to work with. Then we create columns based on WQX schema. We will then drop the first 48 columns from the original report. Lastly, we will reorder the data.

```{r}
formatted_data <- raw_alpha_data |>
  clean_names() |>
  # Are we using calwatch as project ID?
  mutate(
    "Project ID" = "CalWATCH",
    # No location ID or sampleIDin these alpha lab data
    "Monitoring Location ID" = NA,
    "Activity ID User Supplied (PARENTs)" = NA,
    "Activity Type" = "Sample-Routine",
    "Activity Media Name" = matrix,
    "Activity Start Date" = format(mdy_hms(sampdate), "%m/%d/%Y"),
    "Activity Start Time" = format(mdy_hms(sampdate), "%H:%M"),
    "Activity Start Time Zone" = "PST",
    # not depth or height
    "Activity Depth/Height Measure" = NA,
    "Activity Depth/Height Unit" = NA,
    "Sample Collection Method ID" = "BVR SWQAPP",
    "Sample Collection Method Context" = "CA_BVR",
    "Sample Collection Equipment Name" = "Water Bottle",
    "Sample Collection Equipment Comment" = NA,
    "Characteristic Name" = analyte,
    "Characteristic Name User Supplied" = NA,
    "Method Speciation" = NA,
    "Result Detection Condition" = ifelse(result == "Absent", "Not Detected", NA_character_),
    "Result Value" = ifelse(result == "Absent" | result == "ND", NA_character_, result),
    "Result Unit" = ifelse(units == ".", NA_character_, units),
    "Result Measure Qualifier" = NA,
    "Result Sample Fraction" = NA,
    "Result Status ID" = "Final",
    "ResultTemperatureBasis" = NA,
    "Statistical Base Code" = NA,
    "ResultTimeBasis" = NA,
    "Result Value Type" = "Actual",
    "Result Analytical Method ID" = ifelse(is.na(methodcode), NA_character_, methodcode),
    "Activity ID (CHILD-subset)" = make_activity_id(
      location_id = `Monitoring Location ID`,
      date = `Activity Start Date`,
      time = `Activity Start Time`,
      activity_type = `Activity Type`,
      equipment_name = `Sample Collection Equipment Name`,
      depth = `Activity Depth/Height Measure`
    ),
    # Casnumber? Context APHA? 
    "Result Analytical Method ID" = casnumber,
    "Result Analytical Method Context" = "APHA",
    "Analysis Start Date" = format(mdy_hms(anadate), "%m/%d/%Y"),
    "Result Detection/Quantitation Limit Type" = "Lower Reporting Limit",
    "Result Detection/Quantitation Limit Measure" = ifelse(dl == "NA", NA_character_, dl),
    "Result Detection/Quantitation Limit Unit" = ifelse(units == ".", NA_character_, units),
    "Result Comment" = NA
    
  )
```
```{r}
alpha_lab_formatted_for_wqx <- formatted_data |> 
  select(-c(0:48)) |> 
  relocate("Activity ID (CHILD-subset)", .before = "Activity ID User Supplied (PARENTs)")
```

Lastly we export the data to a CSV file.

```{r}
write_csv(alpha_lab_formatted_for_wqx, "data/alpha_lab_wqx.csv", na = "")

```




